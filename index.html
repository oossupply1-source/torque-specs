<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Torque Specs & Oils</title>
<style>
body { font-family: system-ui, -apple-system; background: #0f0f0f; color: #fff; margin:0; padding:16px;}
h1{text-align:center;margin-bottom:10px;}
select,input,button{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:none;font-size:16px;}
button{background:#222;color:#fff;}
button.active{background:#007aff;}
.card{background:#1b1b1b;border-radius:10px;padding:12px;margin-top:10px;}
.spec{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #333;}
.spec:last-child{border-bottom:none;}
.star{cursor:pointer;margin-left:8px;}
.small{font-size:12px;opacity:0.6;text-align:center;}
</style>
</head>
<body>

<h1>Torque Specs & Oils</h1>

<!-- VIN input -->
<input type="text" id="vinInput" placeholder="Enter VIN">
<button onclick="searchVin()">Decode VIN</button>

<!-- Vehicle and engine dropdowns -->
<select id="vehicleSelect" onchange="loadEngines()">
  <option value="">Select Vehicle</option>
</select>

<select id="engineSelect" onchange="loadSpecs()">
  <option value="">Select Engine</option>
</select>

<input type="text" id="search" placeholder="Search Parts..." oninput="filterSpecs()">

<button id="unitBtn" onclick="toggleUnits()">Units: ft-lb</button>

<div class="card" id="results"></div>

<script>
// ---------------- STATE ----------------
let torqueData = {};
let currentVehicle = "";
let currentEngine = "";
let currentSpecs = {};
let unit = localStorage.getItem("unit") || "ft";
let favorites = JSON.parse(localStorage.getItem("favorites") || "{}");

// ---------------- FUNCTIONS ----------------

// Load brand JSONs
async function loadBrandData(){
    const brands = ["toyota","lexus","honda","bmw","ford"];
    let allData = {};
    for(const brand of brands){
        const res = await fetch(`${brand}.json`);
        const data = await res.json();
        allData = {...allData,...data};
    }
    torqueData = allData;
    populateVehicleDropdown();
}

// Populate vehicle dropdown
function populateVehicleDropdown(){
    const vehicleSelect = document.getElementById("vehicleSelect");
    Object.keys(torqueData).forEach(key=>{
        const option = document.createElement("option");
        option.value = key;
        const v = torqueData[key].models.join(", ");
        option.text = `${key.toUpperCase()} (${v})`;
        vehicleSelect.appendChild(option);
    });
}

// Load engines for selected vehicle
function loadEngines(){
    currentVehicle = document.getElementById("vehicleSelect").value;
    currentEngine = "";
    const engineSelect = document.getElementById("engineSelect");
    engineSelect.innerHTML = '<option value="">Select Engine</option>';
    if(currentVehicle && torqueData[currentVehicle].engines){
        Object.keys(torqueData[currentVehicle].engines).forEach(eng=>{
            const option = document.createElement("option");
            option.value = eng;
            option.text = eng;
            engineSelect.appendChild(option);
        });
    }
}

// Load specs for selected engine
function loadSpecs(){
    const engineSelect = document.getElementById("engineSelect");
    currentEngine = engineSelect.value;
    if(currentVehicle && currentEngine){
        currentSpecs = torqueData[currentVehicle].engines[currentEngine];
        renderSpecs(currentSpecs);
    }
}

// Render specs to page
function renderSpecs(specs){
    const results = document.getElementById("results");
    results.innerHTML = "";
    for(const category in specs){
        const catData = specs[category];
        const catDiv = document.createElement("div");
        catDiv.className="card";
        const h = document.createElement("h3");
        h.innerText = category.toUpperCase();
        catDiv.appendChild(h);
        for(const part in catData){
            const val = catData[part];
            const display = val!==null ? convert(val) : "N/A";
            const favKey = currentVehicle+currentEngine+part;
            const star = favorites[favKey] ? "⭐" : "☆";
            const div = document.createElement("div");
            div.className="spec";
            div.innerHTML=`<span><strong>${part}</strong></span><span>${display}<span class="star" onclick="toggleFav('${favKey}')">${star}</span></span>`;
            catDiv.appendChild(div);
        }
        results.appendChild(catDiv);
    }
}

// Search filter
function filterSpecs(){
    const term = document.getElementById("search").value.toLowerCase();
    if(!currentSpecs) return;
    const filtered = {};
    for(const cat in currentSpecs){
        filtered[cat]={};
        for(const part in currentSpecs[cat]){
            if(part.toLowerCase().includes(term)){
                filtered[cat][part]=currentSpecs[cat][part];
            }
        }
        if(Object.keys(filtered[cat]).length===0) delete filtered[cat];
    }
    renderSpecs(filtered);
}

// Toggle units
function toggleUnits(){
    unit = unit==="ft"?"nm":"ft";
    localStorage.setItem("unit",unit);
    document.getElementById("unitBtn").textContent="Units: "+(unit==="ft"?"ft-lb":"Nm");
    renderSpecs(currentSpecs);
}

// Convert values
function convert(value){
    if(unit==="ft") return value+" ft-lb";
    return Math.round(value*1.356)+" Nm";
}

// Toggle favorites
function toggleFav(key){
    favorites[key]=!favorites[key];
    localStorage.setItem("favorites",JSON.stringify(favorites));
    renderSpecs(currentSpecs);
}

// ---------------- VIN decoding ----------------
async function searchVin(){
    const vin = document.getElementById("vinInput").value.trim().toUpperCase();
    if(!vin) return alert("Enter a VIN");
    const res = await fetch('vinMapping.json');
    const vinMapping = await res.json();
    const wmi = vin.slice(0,3);
    const yearChar = vin[9];
    const year = decodeVinYear(yearChar);
    const vehicleData = vinMapping[wmi];
    if(!vehicleData) return alert("VIN not recognized");

    for(const model in vehicleData){
        for(const range in vehicleData[model]){
            const [start,end] = range.split("-").map(Number);
            if(year >= start && year <= end){
                const engines = vehicleData[model][range];
                const engineCode = Object.keys(engines)[0];
                const jsonKey = engines[engineCode];
                document.getElementById("vehicleSelect").value = jsonKey.split("_")[0];
                loadEngines();
                document.getElementById("engineSelect").value = engineCode;
                loadSpecs();
                return;
            }
        }
    }
    alert("VIN not supported");
}

// Decode 10th VIN character to year
function decodeVinYear(c){
    const map = {A:1980,B:1981,C:1982,D:1983,E:1984,F:1985,G:1986,H:1987,J:1988,K:1989,L:1990,M:1991,N:1992,P:1993,R:1994,S:1995,T:1996,V:1997,W:1998,X:1999,Y:2000,
                 1:2001,2:2002,3:2003,4:2004,5:2005,6:2006,7:2007,8:2008,9:2009,
                 A2020:2020,B2021:2021,C2022:2022,D2023:2023,E2024:2024,F2025:2025};
    return map[c] || null;
}

// ---------------- INIT ----------------
loadBrandData();
document.getElementById("unitBtn").textContent = "Units: "+(unit==="ft"?"ft-lb":"Nm");
</script>

</body>
</html>
