<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Torque Specs</title>
<style>
body { background:#0f0f0f; color:#fff; font-family:system-ui,-apple-system; padding:16px; }
input, select, button { width:100%; padding:12px; margin:6px 0; border-radius:8px; border:none; font-size:16px; }
button { background:#222; color:#fff; }
.card { background:#1b1b1b; border-radius:10px; padding:12px; margin-top:10px; }
.spec { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #333; }
.spec:last-child { border-bottom:none; }
</style>
</head>
<body>

<h2>Torque Specs</h2>

<input id="vinInput" placeholder="Enter VIN">
<button onclick="searchVin()">Decode VIN</button>

<select id="vehicleSelect" onchange="loadSpecs()">
  <option value="">Select Vehicle</option>
</select>

<button id="unitBtn" onclick="toggleUnits()">Units: ft-lb</button>

<div id="results"></div>

<script>
let unit = "ft";
let brandData = {};
let currentJsonKey = "";

// VIN Search
async function searchVin() {
  const vin = document.getElementById("vinInput").value.trim().toUpperCase();
  if (vin.length !== 17) return alert("VIN must be 17 characters");

  const wmi = vin.slice(0,3);
  const yearChar = vin[9];
  const year = decodeVinYear(yearChar);
  if(!year) return alert("Unable to decode year from VIN");

  try {
    const res = await fetch("data/vinMapping.json");
    const vinMapping = await res.json();
    const brandMapping = vinMapping[wmi];
    if(!brandMapping) return alert("VIN not recognized");

    let found = false;

    for(const model in brandMapping){
      const ranges = brandMapping[model];
      if(!ranges) continue;

      for(const rangeKey in ranges){
        if(!rangeKey || typeof rangeKey!=="string") continue;
        const [start,end] = rangeKey.split("-").map(Number);
        if(isNaN(start) || isNaN(end)) continue;

        if(year>=start && year<=end){
          const engines = ranges[rangeKey];
          const engineCode = Object.keys(engines)[0];
          currentJsonKey = engines[engineCode].jsonKey; // e.g., 'lexus_is300_1999_2005'
          const make = currentJsonKey.split("_")[0];    // 'lexus'

          await loadBrand(make, currentJsonKey);
          found = true;
          break;
        }
      }
      if(found) break;
    }

    if(!found) alert("VIN decoded but model not found in JSON files");

  } catch(err) {
    console.error(err);
    alert("Error reading VIN mapping: " + err.message);
  }
}

// Load brand JSON data
async function loadBrand(make, jsonKey){
  try{
    const res = await fetch(`data/${make}.json`);
    if(!res.ok) throw new Error("Brand JSON not found");
    brandData = await res.json();

    const vehicleSelect = document.getElementById("vehicleSelect");
    vehicleSelect.innerHTML = `<option value="">Select Vehicle</option>`;

    if(!brandData[jsonKey]) return alert("Vehicle data not found in JSON");

    const opt = document.createElement("option");
    opt.value = jsonKey;
    opt.textContent = brandData[jsonKey].models[0] + ` (${brandData[jsonKey].years})`;
    vehicleSelect.appendChild(opt);
    vehicleSelect.selectedIndex = 1;

    loadSpecs();
  } catch(err){
    alert("Error loading brand data: " + err.message);
    console.error(err);
  }
}

// Load specs for selected vehicle
function loadSpecs(){
  const key = document.getElementById("vehicleSelect").value;
  const v = brandData[key];
  if(!v) return;

  const results = document.getElementById("results");
  results.innerHTML = "";

  render("Powertrain", {
    "Engine": v.powertrain.engine_name,
    "Transmission": v.powertrain.transmission_name,
    "Differential": v.powertrain.differential_name
  });

  render("Engine Specs", v.engine);
  render("Transmission Specs", v.transmission);
  render("Differential Specs", v.differential);
  if(v.fluids) render("Fluids & Capacities", v.fluids);
}

// Render cards
function render(title,obj){
  if(!obj) return;
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `<h3>${title}</h3>`;
  for(const k in obj){
    const val = typeof obj[k]==="number" ? convert(obj[k]) : obj[k];
    card.innerHTML += `<div class="spec"><span>${k}</span><span>${val}</span></div>`;
  }
  document.getElementById("results").appendChild(card);
}

// Unit toggle
function toggleUnits(){
  unit = unit==="ft" ? "nm" : "ft";
  document.getElementById("unitBtn").textContent = unit==="ft" ? "Units: ft-lb" : "Units: Nm";
  loadSpecs();
}

// Convert ft-lb <-> Nm
function convert(v){
  return unit==="ft" ? `${v} ft-lb` : `${Math.round(v*1.356)} Nm`;
}

// Decode VIN year (10th char)
function decodeVinYear(c){
  const map = {
    A:1980,B:1981,C:1982,D:1983,E:1984,F:1985,G:1986,H:1987,J:1988,K:1989,L:1990,M:1991,N:1992,P:1993,R:1994,S:1995,T:1996,V:1997,W:1998,X:1999,Y:2000,
    1:2001,2:2002,3:2003,4:2004,5:2005,6:2006,7:2007,8:2008,9:2009,
    A2020:2020,B2021:2021,C2022:2022,D2023:2023,E2024:2024,F2025:2025
  };
  return map[c] || null;
}
</script>

</body>
</html>
